<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Nyanpollo Demo</title>
	<script src="lib/jquery.js"></script>
	<script src="lib/mediaelement.js"></script>
	<script src="data/timeAdjustments.js"></script>
	<script src="data/sensorData.js"></script>
	<style type="text/css">
		#player1 {
			float: left;
		}
		#dashboard {
			margin-left: 650px;
		}
	</style>
</head>
<body>

<video id="player1" src="../full-video.mp4" type="video/mp4" controls="controls"></video>

<div id="dashboard">
	<ul>
		<li><b>seconds of video:</b> <span id="seconds"></span></li>
		<li><b>time:</b> <span id="time"></span></li>
		<li><b>altitude:</b> <span id="altitude">???</span> meters</li>
		<li><b>compass:</b> <span id="compass">Look Up</span></li>
	</ul>
</div>

<script>

// Get the time adjustment offset
function getTimeAdjustment( ms ) {
	var lastAdjustment = timeAdjustments[0];
	for (var i=0;i<timeAdjustments.length;i++) {
		var adjustment = timeAdjustments[ i ];
		if (ms < adjustment.videoTime) {
			break;
		}
		lastAdjustment = adjustment;
	}
	return lastAdjustment;
};

// Given the video seconds, apply adjustment and give a real timestamp
function getRealTime( ms ) {
	// {duration: "17s", videoTime: 16770, timestamp: 1445718882843, date: "2015-10-24T20:34:42+00:00"}
	var adjustment = getTimeAdjustment( ms );
	var difference = ms - adjustment.videoTime;
	return adjustment.timestamp + difference;
}

// Get the latest data packet
function getDataPacket( timestamp ) {
	var lastData = sensorData[0];
	for (var i=0;i<sensorData.length;i++) {
		var data = sensorData[i];
		if ( timestamp < data.time ) {
			break;
		}
		lastData = data;
	}
	return lastData;
}

MediaElement('player1', {success: function(me) {
	me.play();

	var lastUpdate = 0;
	me.addEventListener('timeupdate', function() {

		// Simple debounce to prevent double calls
		if (lastUpdate == me.currentTime) { return; }
		lastUpdate = me.currentTime;

		// This whole thing must take 30ms or less
		var ms = me.currentTime * 1000;
		var realTime = getRealTime( ms );
		var data = getDataPacket( realTime );
		document.getElementById('seconds').innerHTML = me.currentTime;
		document.getElementById('time').innerHTML = new Date(realTime);
		if (data) {
			console.log( data );
			document.getElementById('compass').innerHTML = data.heading;
			if (data.aprs) {
				document.getElementById('altitude').innerHTML = data.aprs.altitude;
			}
		}
	}, false);

}});
</script>

</body>
</html>