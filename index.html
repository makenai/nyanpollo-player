<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Nyanpollo Demo</title>
	<script src="vendor/jquery.js"></script>
	<script src="vendor/jquery.sparkline.js"></script>
	<script src="vendor/lodash.js"></script>
	<script src="vendor/moment.js"></script>
	<script src="vendor/mediaelement.js"></script>
	<script src="bootstrap/js/bootstrap.min.js"></script>
	<script src="data/timeAdjustments.js"></script>
	<script src="data/sensorData.js"></script>
	<script src="lib/nyanpollo-units.js"></script>
	<script src="lib/nyanpollo-data.js"></script>
	<script src="lib/nyanpollo-map.js"></script>
	<script src="lib/nyanpollo-player.js"></script>
	<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
	<link href="css/nyanpollo-player.css" rel="stylesheet" media="screen">
</head>
<body>
<div class="container-fluid">
	<div class="row">
		<div class="col-md-6">
			<div class="embed-responsive embed-responsive-4by3">
				<video id="video" class="embed-responsive-item" src="../full-video.mp4" type="video/mp4" controls="controls"></video>
			</div>
		</div>
		<div class="col-md-6" id="dashboard">
			<!-- <img src="img/nyanpollo-1.png" /> -->
			<h2>NYANPOLLO-1</h2>
			<table class="table table-condensed">
				<tr>
					<th>time:</th>
					<td><span id="time"></span></td>
				</tr>
				<tr>
					<th>since launch:</th>
					<td><span id="flighttime"></span></td>
				</tr>
				<tr>
					<th>altitude:</th>
					<td>
						<span id="altitude"></span>
						<span id="altitude-chart"></span>
					</td>
				</tr>
				<tr>
					<th>course:</th>
					<td>
						<span id="course"></span>
						<img src="img/arrow.svg" id="course-needle" />
					</td>
				</tr>
				<tr>
					<th>speed:</th>
					<td>
						<span id="speed"></span>
						<span id="speed-chart"></span>
					</td>
				</tr>
				<tr>
					<th>temperature:</th>
					<td>
						<span id="temperature"></span>
						<span id="temperature-chart"></span>
					</td>
				</tr>
				<tr>
					<th><b>pressure:</b></th>
					<td>
						<span id="pressure"></span>
						<span id="pressure-chart"></span>
					</td>
				</tr>
				<tr>
					<th>altitude from kPa:</th>
					<td>
						<span id="altitudekPa"></span>
					</td>
				</tr>
				<tr>
					<th>orientation:</th>
					<td>
						<span id="compass"></span>
						<img src="img/arrow.svg" id="compass-needle" />
					</td>
				</tr>
				<tr>
					<th>data frame:</th>
					<td><span id="dataframe"></td>
				</tr>
			</table>
		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<div id="map"></div>
		</div>
	</div>
</div>
<script type="text/javascript">

var map;
function initMap() {
	map = new NyanpolloMap(document.getElementById('map'), {
		startPosition: { lat: 36.02933, lng: -115.82533 },
		icon: 'img/nyancon.gif'
	});
};

var dataSource = new NyanpolloData(sensorData, {
	timeAdjustments: timeAdjustments
});

MediaElement('video', {success: function(me) {
	// me.play();
	// Max height 99921.00 feet

	// Completely hardcoded value when we let go of the balloon
	var launchTime = 1445718862322.426;
	var lastUpdate = 0;
	var initialPressure = dataSource.getFirst('pressure');
	me.addEventListener('timeupdate', function() {

		// Simple debounce to prevent double calls
		if (lastUpdate == me.currentTime) { return; }
		lastUpdate = me.currentTime;

		// This whole thing must take 30ms or less
		var currentMs = me.currentTime * 1000;

		var realTime = dataSource.getTime( currentMs );
		var data = dataSource.getData( realTime );
		var timeSinceLaunch = realTime - launchTime;

		updateData('time', new Date(realTime));
		updateData('flighttime', formatSeconds(timeSinceLaunch / 1000));
		if (data) {
			updateData('dataframe', data._index);
			updateData('compass', data.heading, '&deg;' );
			updateRotation('compass-needle', data.heading);
			updateData('temperature', data.temperature && data.temperature.toFixed(2), '&deg; F');
			updateChart('temperature-chart', data, 'temperature');
			updateData('pressure', data.pressure && parseFloat(data.pressure).toFixed(2), ' kPa');
			updateChart('pressure-chart', data, 'pressure');
			if (data.pressure) {
				updateData('altitudekPa', metersToFeet(
						kPaToAltitude( initialPressure, data.pressure )
					).toFixed(2), ' feet');
			} else {
				updateData('altutidekPa', null);
			}
			if (data.aprs) {
				updateData('altitude', metersToFeet(data.aprs.altitude).toFixed(2), ' feet');
				updateChart('altitude-chart', data, 'aprs.altitude');
				updateData('course', data.aprs.course, '&deg;');
				updateRotation('course-needle', data.aprs.course);
				updateData('speed', kilometersToMiles( data.aprs.speed ).toFixed(2), ' mph');
				updateChart('speed-chart', data, 'aprs.speed');
				if (map) {
					updateMap( map, data );
				}
			}
		}
	}, false);

}});
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAc5Ro-h3Bpe29eonhjmwfLimoj6BWE0RM&callback=initMap"async defer></script>
</body>
</html>